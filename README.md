# PDF â†’ Markdown + Image Extraction + Vision Captioning Pipeline

A complete end-to-end Python pipeline that converts PDFs to Markdown, extracts all images, and generates AI-powered captions using MiniCPM-V-2.6.

## ğŸ¯ What This Does

This pipeline performs four key tasks:

1. **Converts PDFs to Markdown** - Preserves document structure and formatting
2. **Extracts all images** - Pulls every embedded image from your PDF
3. **Generates AI captions** - Uses MiniCPM-V-2.6 vision model to describe each image
4. **Produces final Markdown** - Creates a complete document with text, images, and captions

## ğŸš€ Features

- âœ… PDF â†’ Markdown conversion using Docling
- âœ… High-quality image extraction from PDFs
- âœ… AI vision caption generation for every image
- âœ… Full pipeline orchestrator to merge everything
- âœ… Works with local PDFs and URLs
- âœ… Clean output folder structure
- âœ… GPU support for fast inference
- âœ… Automatic device detection (CUDA/CPU)

## ğŸ“‹ Prerequisites

- Python 3.8 or higher
- GPU with CUDA support (recommended for speed)
- Hugging Face account and access token

## ğŸ” Hugging Face Token (Required)

MiniCPM-V-2.6 requires authentication with Hugging Face.

### Get Your Token:
1. Create account at [huggingface.co](https://huggingface.co)
2. Go to Settings â†’ Access Tokens
3. Create a new token with read permissions
4. Copy your token

### Add Token to Code:
Insert this line **before the model loads** in either `test_minicpm_caption.py` or `app.py`:

```python
from huggingface_hub import login
login("YOUR_HF_TOKEN_HERE")
```

## ğŸ›  Installation

### Step 1: Clone the Repository

```bash
git clone <your-repo-url>
cd pdf_image_extract_captioner
```

### Step 2: Create Virtual Environment

```bash
python3 -m venv ds
source ds/bin/activate  # On Windows: ds\Scripts\activate
```

### Step 3: Install Dependencies

```bash
pip install -r requirements.txt
```

### Step 4: Verify Installation

```bash
python3 -c "from docling.document_converter import DocumentConverter; print('âœ“ Docling is ready!')"
```

If this prints "âœ“ Docling is ready!" without errors, you're all set!

## ğŸ“‚ Project Structure

```
pdf_image_extract_captioner/
â”œâ”€â”€ app.py                             # Main orchestrator (run this!)
â”œâ”€â”€ test_minicpm_caption.py            # MiniCPM captioning model
â”œâ”€â”€ pdf_to_markdown_with_captions.py   # PDF extraction logic
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ pdf_extractor.py               # Core extraction helper
â”œâ”€â”€ requirements.txt                    # Python dependencies
â”œâ”€â”€ README.md                          # This file
â””â”€â”€ temp_extraction/
    â””â”€â”€ images/                        # Auto-created for extracted images
```

## â–¶ï¸ Usage

### Run Full Pipeline (Recommended)

This runs the complete pipeline: extraction + captioning + final markdown generation.

```bash
python3 app.py input.pdf output.md
```

**Example:**
```bash
python3 app.py research_paper.pdf final_output.md
```

### Run Individual Components

#### Extract Only Text + Images (No Captions)
```bash
python3 pdf_to_markdown_with_captions.py input.pdf output.md
```

#### Caption a Single Image
```bash
python3 test_minicpm_caption.py path/to/image.png
```

## ğŸ”„ How It Works

### Pipeline Flow:

1. **PDF Processing** â†’ Docling extracts text as Markdown and saves all embedded images
2. **Image Captioning** â†’ Each image is processed by MiniCPM-V-2.6 to generate descriptions
3. **Merging** â†’ Captions are inserted below corresponding images in the Markdown
4. **Output** â†’ Final Markdown file is saved with text, images, and captions

### Output Structure:

Your final Markdown will look like:

```markdown
# Document Title

Document text content...

![Image 1](temp_extraction/images/image_1.png)
*Caption: A detailed description of the image generated by AI*

More document text...

![Image 2](temp_extraction/images/image_2.png)
*Caption: Another AI-generated description*
```

## ğŸ“ Main Components

### 1. `test_minicpm_caption.py` â€” Vision Caption Model

Loads the MiniCPM-V-2.6 model and generates captions for images.

**Responsibilities:**
- Load model + tokenizer
- Accept image path as input
- Generate caption text
- Return caption string
- Automatic GPU/CPU detection

### 2. `pdf_to_markdown_with_captions.py` â€” PDF Extraction

Handles all Docling-based PDF processing.

**Responsibilities:**
- Convert PDF â†’ Markdown
- Extract embedded images
- Save images to `temp_extraction/images/`
- Output raw extracted markdown

*Note: No captioning happens here â€” only PDF parsing + extraction.*

### 3. `app.py` â€” Main Orchestrator

Combines extraction + captioning into a complete workflow.

**Workflow:**
1. Run PDF extraction
2. Collect extracted images
3. Send each image to MiniCPM caption generator
4. Append captions below images in Markdown
5. Save final `final_markdown.md`

**This is the recommended file to run.**

## âš¡ GPU vs CPU Performance

MiniCPM-V-2.6 is a large vision-language model:

| Device | Speed | Recommendation |
|--------|-------|----------------|
| **GPU** | Fast (seconds per image) | âœ… Recommended |
| **CPU** | Very slow (minutes per image) | âŒ Not recommended |

### Enable GPU:

The code automatically detects CUDA availability:

```python
device = "cuda" if torch.cuda.is_available() else "cpu"
model.to(device)
```

To use GPU, ensure you have:
- NVIDIA GPU with CUDA support
- PyTorch installed with CUDA support

## ğŸª› Troubleshooting

### Docling Issues

**Problem:** Import errors or conversion failures

**Solutions:**
- Ensure Python 3.8+
- Reinstall dependencies: `pip install -r requirements.txt --force-reinstall`
- Try the import test: `python3 -c "from docling.document_converter import DocumentConverter"`

### MiniCPM Model Extremely Slow

**Problem:** Captioning takes minutes per image

**Cause:** You're using CPU instead of GPU

**Solutions:**
- Install CUDA-enabled PyTorch
- Check GPU availability: `python3 -c "import torch; print(torch.cuda.is_available())"`
- Reduce image resolution if needed
- Consider using a smaller vision model

### No Images Extracted

**Problem:** Markdown generated but no images appear

**Possible causes:**
- PDF contains only text (no embedded images)
- PDF uses scanned pages instead of embedded images

**Solutions:**
- Enable page image fallback in Docling settings
- Check if PDF actually contains images
- Try different PDF extraction settings

### Hugging Face Authentication Error

**Problem:** Model download fails

**Solutions:**
- Verify your HF token is correct
- Ensure `login()` is called before model loading
- Check internet connection
- Visit model page: [MiniCPM-V-2.6](https://huggingface.co/openbmb/MiniCPM-V-2_6)

## ğŸ“¦ Requirements

Key dependencies (see `requirements.txt` for full list):

- `docling` - PDF to Markdown conversion
- `torch` - PyTorch for deep learning
- `transformers` - Hugging Face models
- `Pillow` - Image processing
- `huggingface_hub` - Model authentication

## ğŸ¤ Contributing

Contributions are welcome! Please feel free to submit pull requests or open issues.

## ğŸ“„ License

[Add your license here]

## ğŸ™ Acknowledgments

- [Docling](https://github.com/DS4SD/docling) for PDF processing
- [MiniCPM-V-2.6](https://huggingface.co/openbmb/MiniCPM-V-2_6) for vision captioning
- Hugging Face for model hosting

## ğŸ“ Support

If you encounter issues:
1. Check the Troubleshooting section above
2. Review error messages carefully
3. Open an issue with full error logs
4. Include your Python version and OS

---

